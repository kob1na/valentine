:root{
  --bg1:#120818; --bg2:#2a0f2a;
  --bgA: radial-gradient(1200px 700px at 20% 10%, #3a0f3a 0%, transparent 60%);
  --bgB: radial-gradient(900px 600px at 80% 30%, #3a1030 0%, transparent 55%);
  --stroke: rgba(255,255,255,.14);
  --pink:#ff4da6; --red:#ff2e55; --gold:#ffd27a;
  --txt: rgba(255,255,255,.92);
  --muted: rgba(255,255,255,.72);
}

*{box-sizing:border-box}
html,body{height:100%;margin:0;font-family:ui-sans-serif,system-ui,-apple-system,Segoe UI,Roboto,Arial}

/* IMPORTANT: allow scroll */
body{
  overflow-x:hidden;
  overflow-y:auto;
  -webkit-overflow-scrolling: touch;

  background:
    var(--bgA),
    var(--bgB),
    linear-gradient(160deg, var(--bg1), var(--bg2));
  color: var(--txt);
  transition: background 1200ms ease;
}

body.dawn{
  --bg1:#1c0b1f;
  --bg2:#4a1b2a;
  --bgA: radial-gradient(1200px 700px at 20% 10%, rgba(255,170,120,.18) 0%, transparent 60%);
  --bgB: radial-gradient(900px 600px at 80% 30%, rgba(255,77,166,.18) 0%, transparent 55%);
}

/* ================================
   CANVASES (ALWAYS NON-INTERACTIVE)
   IMPORTANT FIX: never catch clicks
================================ */
#heartsBg, #stars, #fx{
  position:fixed;
  inset:0;
  pointer-events:none !important;
}

/* Layering:
   canvases behind,
   UI above.
*/
#heartsBg{ z-index:0; opacity:.55; transition: opacity 800ms ease; }
#stars{ z-index:1; }
#fx{ z-index:2; }

/* stage */
.stage{
  position:relative;
  z-index:10; /* above canvases */
  min-height:100vh;
  display:grid;
  place-items:center;
  padding:22px 22px 60px;
}

.scene{display:none; width:min(880px, 96vw); position:relative; z-index:11;}
.scene.active{display:block}
.scene-letter{position:relative; z-index:12;}

.hintTop,.hintBottom{
  text-align:center;
  color: rgba(255,255,255,.80);
  font-size:14px;
  letter-spacing:.2px;
  margin: 10px 0 16px;
}

/* MUSIC */
.musicBtn{
  position:fixed;
  left:16px; top:14px;
  z-index:80; /* must be above everything */
  border:1px solid rgba(255,255,255,.20);
  background: rgba(0,0,0,.28);
  color: rgba(255,255,255,.96);
  padding:12px 14px;
  border-radius:16px;
  cursor:pointer;
  backdrop-filter: blur(12px);
  font-weight:950;
  display:flex;
  align-items:center;
  gap:10px;
  box-shadow: 0 18px 60px rgba(0,0,0,.35);
}
.musicBtn.playing{ background: rgba(255,77,166,.22); }
.musicDot{
  width:10px;height:10px;border-radius:999px;
  background: rgba(255,255,255,.60);
}
.musicText{display:flex; align-items:center; gap:10px}
.musicWave{display:inline-flex; gap:3px; align-items:flex-end; height:14px}
.musicWave .bar{
  width:3px; border-radius:8px;
  height:6px;
  background: rgba(255,255,255,.55);
  opacity:.65;
}
.musicBtn.playing .musicWave .bar{
  opacity:1;
  background: rgba(255,210,122,.92);
  animation: wave 900ms ease-in-out infinite;
}
.musicBtn.playing .musicWave .b2{animation-delay:120ms}
.musicBtn.playing .musicWave .b3{animation-delay:240ms}
.musicBtn.playing .musicWave .b4{animation-delay:360ms}
@keyframes wave{
  0%,100%{height:4px}
  50%{height:14px}
}

/* ================================
   TOP CONTROLS (quiet button)
================================ */
.topControls{
  position:fixed;
  top:14px;
  right:16px;
  z-index:80;
}
.chip{
  padding:10px 14px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background:rgba(0,0,0,.25);
  color:white;
  cursor:pointer;
  font-weight:900;
}

/* ENVELOPE */
.envelopeWrap{display:grid;place-items:center}
.envelope{
  position:relative;
  z-index:20; /* above stage */
  width:min(560px, 94vw);
  height:340px;
  border-radius:28px;
  filter: drop-shadow(0 35px 80px rgba(0,0,0,.45));
}

/* IMPORTANT FIX:
   all decorative envelope layers must not steal touches,
   only .seal is interactive
*/
.envBack,
.envFront,
.flap,
.paperPeek,
.paperEdge{
  pointer-events:none;
}

.envBack{
  position:absolute; inset:0;
  background: linear-gradient(180deg, rgba(255,255,255,.11), rgba(255,255,255,.06));
  border:1px solid var(--stroke);
  border-radius:28px;
  backdrop-filter: blur(18px);
}
.envFront{
  position:absolute; inset:0;
  border-radius:28px;
  background:
    radial-gradient(600px 260px at 40% 20%, rgba(255,77,166,.18), transparent 55%),
    radial-gradient(500px 240px at 70% 70%, rgba(255,210,122,.16), transparent 55%),
    rgba(0,0,0,.12);
  border:1px solid rgba(255,255,255,.10);
}
.flap{
  position:absolute; left:0; right:0; top:0;
  height:56%;
  transform-origin: top center;
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.02));
  border-top-left-radius:28px;
  border-top-right-radius:28px;
  border:1px solid rgba(255,255,255,.10);
  clip-path: polygon(0 0, 100% 0, 50% 100%);
  transition: transform 900ms cubic-bezier(.2,.9,.1,1);
}
.envelope.open .flap{ transform: rotateX(160deg); }
.paperPeek{
  position:absolute; left:10%; right:10%;
  bottom:18px; height:78%;
  border-radius:18px;
  transform: translateY(20px);
  opacity:0;
  transition: transform 900ms cubic-bezier(.2,.9,.1,1), opacity 800ms ease;
}
.envelope.open .paperPeek{ transform: translateY(-10px); opacity:1; }
.paperEdge{
  position:absolute; inset:0;
  border-radius:18px;
  background:
    linear-gradient(180deg, rgba(255,255,255,.18), rgba(255,255,255,.05)),
    rgba(0,0,0,.05);
  border:1px solid rgba(255,255,255,.10);
}

/* SEAL */
.seal{
  position:absolute;
  left:50%; top:58%;
  width:96px; height:96px;
  transform: translate(-50%,-50%);
  border-radius:999px;
  background: radial-gradient(circle at 30% 30%, #ff9ad0 0%, var(--pink) 35%, var(--red) 70%);
  box-shadow: 0 18px 50px rgba(255,46,85,.25), inset 0 0 0 2px rgba(255,255,255,.14);
  display:grid; place-items:center;
  cursor:grab;
  user-select:none;
  touch-action:none;
  pointer-events:auto; /* IMPORTANT */
  z-index:25;         /* IMPORTANT */
}
.seal:active{cursor:grabbing}
.sealText{
  text-align:center;
  font-weight:950;
  font-size:12px;
  color: rgba(255,255,255,.92);
  text-shadow: 0 6px 18px rgba(0,0,0,.25);
}
.seal.broken{ animation: pop 450ms ease forwards; }
@keyframes pop{
  0%{transform: translate(-50%,-50%) scale(1)}
  60%{transform: translate(-50%,-50%) scale(1.10)}
  100%{transform: translate(-50%,-50%) scale(0.0); opacity:0}
}

/* LETTER */
.letterWrap{display:grid;place-items:center}
.letter{
  width:min(720px, 96vw);
  border-radius:28px;
  background: rgba(255,255,255,.08);
  border:1px solid rgba(255,255,255,.12);
  backdrop-filter: blur(18px);
  box-shadow: 0 30px 90px rgba(0,0,0,.50);
  overflow:hidden;
  position:relative;
  z-index:30;
}
.letterHeader{
  padding:18px 18px 10px;
  display:flex; align-items:center; justify-content:space-between;
}
.stamp{
  font-size:12px;
  color: rgba(255,255,255,.86);
  border:1px solid rgba(255,255,255,.14);
  padding:8px 12px;
  border-radius:999px;
  background: rgba(0,0,0,.14);
  cursor:pointer;
  font-weight:950;
}
.title{color: rgba(255,255,255,.92); font-weight:980; letter-spacing:.4px}

.letterBody{
  background: linear-gradient(180deg, rgba(255,255,255,.10), rgba(255,255,255,.05));
  padding: 18px;
}
.line{margin:0;color:rgba(255,255,255,.94); font-size:20px; font-weight:980}
.subline{margin:10px 0 0; color: rgba(255,255,255,.74)}
.tapToContinue{
  margin:14px 0 0;
  padding:12px 14px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.12);
  color: rgba(255,255,255,.84);
  font-size:14px;
}
.story{margin-top:14px; min-height: 120px;}
.story p{
  margin: 10px 0;
  color: rgba(255,255,255,.92);
  line-height:1.45;
  opacity:0;
  transform: translateY(8px);
  animation: rise 520ms ease forwards;
}
@keyframes rise{to{opacity:1; transform: translateY(0)}}
.hidden{display:none}

/* SCRATCH */
.scratchBlock{
  margin-top:16px;
  padding:14px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.10);
}
.scratchTitle{font-weight:980; color:rgba(255,255,255,.92)}
.scratchWrap{
  margin-top:10px;
  position:relative;
  border-radius:18px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  height:140px;
}
.scratchHidden{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
  text-align:center;
  padding:0 14px;

  font-weight:980;
  font-size:18px;
  color:white;

  /* Делаем текст полностью скрытым фоном */
  background:#1b0f1f;  /* плотный тёмный фон */

  z-index:1;
}
.scratchCanvas{
  position:absolute;
  inset:0;
  width:100%;
  height:100%;
  touch-action:none;
  z-index:2;
}

.scratchHint{margin-top:10px;color:rgba(255,255,255,.74);font-size:13px}

/* MINI GAME */
.miniGame{
  margin-top:16px;
  padding:14px;
  border-radius:18px;
  border:1px dashed rgba(255,255,255,.22);
  background: rgba(0,0,0,.10);
}
.miniTitle{font-weight:980; color:rgba(255,255,255,.92)}
.miniText{margin:8px 0 12px; color:rgba(255,255,255,.74); font-size:14px}
.pieces{display:flex; gap:12px; flex-wrap:wrap;}
.piece{
  width:64px;height:64px;border-radius:18px;
  border:1px solid rgba(255,255,255,.14);
  background: radial-gradient(circle at 30% 30%, #ff9ad0 0%, var(--pink) 32%, var(--red) 70%);
  box-shadow: 0 18px 40px rgba(255,46,85,.18);
  cursor:grab;
  touch-action:none;
  position:relative;
}
.piece:active{cursor:grabbing}
.p1{transform: rotate(-8deg)}
.p2{transform: rotate(6deg)}
.p3{transform: rotate(-2deg)}
.dropZone{
  margin-top:12px;
  height:120px;
  border-radius:22px;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,255,255,.06);
  display:grid;
  place-items:center;
  position:relative;
  overflow:hidden;
}
.dropGlow{
  position:absolute; inset:-40px;
  background:
    radial-gradient(circle at 30% 30%, rgba(255,77,166,.22), transparent 60%),
    radial-gradient(circle at 70% 70%, rgba(255,210,122,.16), transparent 55%);
  filter: blur(20px);
}
.dropText{position:relative; color: rgba(255,255,255,.84); font-weight:980}

/* HOLD */
.holdReveal{
  margin-top:16px;
  padding:14px;
  border-radius:18px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(0,0,0,.10);
}
.holdTitle{font-weight:980;color:rgba(255,255,255,.92)}
.holdText{margin:6px 0 12px; color:rgba(255,255,255,.74); font-size:14px}
.holdBtn{
  width:100%;
  height:54px;
  border-radius:16px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.06);
  position:relative;
  overflow:hidden;
  cursor:pointer;
}
.holdFill{
  position:absolute; inset:0;
  width:0%;
  background: linear-gradient(90deg, rgba(255,77,166,.55), rgba(255,210,122,.45));
}
.holdLabel{position:relative;font-weight:980;color: rgba(255,255,255,.92);}

/* FINAL + handwritten */
.final{margin-top:16px;text-align:center}
.finalBigWrap{position:relative; height:44px; display:grid; place-items:center}
.finalBig{
  font-size:30px;
  font-weight:990;
  color:rgba(255,255,255,.96);
}
.finalBig.hand{
  position:absolute;
  inset:0;
  display:grid;
  place-items:center;
  opacity:0;
  transform: translateY(8px) rotate(-1deg);
  font-family: "Segoe Script", "Brush Script MT", "Comic Sans MS", cursive;
  letter-spacing: .6px;
  text-shadow: 0 10px 30px rgba(255,77,166,.25);
}
.finalBig.hand.show{
  animation: handIn 900ms ease forwards;
}
@keyframes handIn{
  to{opacity:1; transform: translateY(0) rotate(-1deg);}
}
.finalSmall{margin-top:10px; color: rgba(255,255,255,.78)}

/* heart interactive */
.heartZone{margin:14px 0 4px; display:grid; place-items:center; gap:8px}
.heartBtn{
  width:86px; height:86px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.18);
  background: rgba(255,255,255,.08);
  backdrop-filter: blur(12px);
  cursor:pointer;
  position:relative;
  box-shadow: 0 20px 70px rgba(0,0,0,.35);
  overflow:hidden;
}
.heartGlow{
  position:absolute; inset:-40px;
  background:
    radial-gradient(circle at 30% 30%, rgba(255,77,166,.35), transparent 55%),
    radial-gradient(circle at 70% 70%, rgba(255,210,122,.25), transparent 55%);
  filter: blur(18px);
}
.heartIcon{
  position:relative;
  font-size:34px;
  display:inline-block;
  transform: translateY(2px);
}
.heartBtn.pulse .heartIcon{
  animation: beat 900ms ease-in-out infinite;
}
@keyframes beat{
  0%,100%{transform:translateY(2px) scale(1)}
  40%{transform:translateY(2px) scale(1.18)}
  60%{transform:translateY(2px) scale(1.06)}
}
.heartHint{color:rgba(255,255,255,.76); font-size:13px}

/* photo tables */
.photosTitle{margin-top:16px; color: rgba(255,255,255,.92); font-weight:980}
.photoTable{
  margin-top:10px;
  display:grid;
  grid-template-columns: repeat(5, minmax(0, 1fr));
  gap:10px;
}
@media (max-width: 720px){
  .photoTable{grid-template-columns: repeat(2, minmax(0, 1fr));}
}
.thumb{
  border-radius:16px;
  overflow:hidden;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.08);
  box-shadow: 0 18px 50px rgba(0,0,0,.35);
  position:relative;
}
.thumb img{width:100%;height:140px;object-fit:cover;display:block}
.thumb .cap{
  position:absolute; left:10px; right:10px; bottom:10px;
  padding:8px 10px;
  border-radius:12px;
  background: rgba(0,0,0,.28);
  color: rgba(255,255,255,.92);
  font-weight:980;
  font-size:12px;
  backdrop-filter: blur(10px);
}

/* actions */
.actions{margin-top:14px;display:flex;gap:10px;justify-content:center;flex-wrap:wrap}
.btn{
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.10);
  color: rgba(255,255,255,.92);
  border-radius:16px;
  padding:12px 14px;
  cursor:pointer;
  font-weight:980;
}
.btn:hover{background: rgba(255,255,255,.14)}
.btn:active{transform: scale(.99)}
.btn.ghost{background: rgba(0,0,0,.10)}

/* footer */
.letterFooter{
  padding: 12px 18px 18px;
  color: rgba(255,255,255,.70);
  font-size:13px;
  display:flex; justify-content:space-between; gap:12px; align-items:center;
}
.signature{cursor:default; user-select:none}
.secretBadge{
  padding:6px 10px;
  border-radius:999px;
  border:1px solid rgba(255,255,255,.16);
  background: rgba(255,77,166,.14);
  color: rgba(255,255,255,.92);
  font-weight:980;
}

/* modal */
.modal{
  position:fixed; inset:0;
  z-index:200; /* above all */
  display:grid;
  place-items:center;
  background: rgba(0,0,0,.45);
  backdrop-filter: blur(10px);
}
.modalCard{
  width:min(520px, 92vw);
  border-radius:22px;
  border:1px solid rgba(255,255,255,.14);
  background: rgba(255,255,255,.10);
  box-shadow: 0 30px 90px rgba(0,0,0,.55);
  padding:16px;
}
.modalTitle{font-weight:990; font-size:18px}
.modalText{margin:10px 0 14px; color: rgba(255,255,255,.86); line-height:1.45}

/* universal */
.hidden{display:none !important;}

/* когда рукописный появился — скрываем печатный */
.finalBig.hidePrint{
  opacity:0;
}

/* ================================
   ADD-ON: breath moment
================================ */
body.breath{
  filter: blur(1px) brightness(.9);
  transition: filter 300ms ease;
}

/* ================================
   ADD-ON: quiet mode
================================ */
body.quiet{
  filter: brightness(.8);
}
body.quiet #heartsBg,
body.quiet #stars{
  opacity:.15;
}

/* ================================
   ADD-ON: dawn emotion
================================ */
body.dawnEmotion{
  filter: brightness(1.05) saturate(1.08);
}

/* ================================
   ADD-ON: handwritten shiver
================================ */
.finalBig.hand.shiver{
  animation: shiver 300ms ease-in-out 4;
}
@keyframes shiver{
  0%{transform: translateY(0) rotate(-1deg)}
  50%{transform: translateY(0) rotate(1deg)}
  100%{transform: translateY(0) rotate(-1deg)}
}

/* ================================
   ADD-ON: heart speed mode
================================ */
.heartBtn.fast .heartIcon{
  animation: fastBeat 300ms infinite;
}
@keyframes fastBeat{
  0%,100%{transform:translateY(2px) scale(1)}
  50%{transform:translateY(2px) scale(1.3)}
}

/* overlays must NOT block clicks when hidden */
.breathOverlay.hidden,
.quietOverlay.hidden{
  pointer-events:none !important;
}
